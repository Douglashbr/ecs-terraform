# Terraform ECS Fargate boilerplate

This repository is a boilerplate to create an ECR repository to store and serve our docker image and a complete ECS Fargate infra to serve our application.

## Software dependency

- Terraform 1.9.5 - [Terraform install](https://developer.hashicorp.com/terraform/install?product_intent=terraform#linux)
- aws >= 2.0.0 - [AWS CLI install](https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html)
- Docker >= 26.0.0 - [Docker install](https://docs.docker.com/engine/install/ubuntu/)
- Nodejs stable version - [Nodejs install](https://nodejs.org/en/download/package-manager)

## Before start

Run `terraform init` on each terraform repository:

```sh
terraform -chdir=$HOME/ecs-terraform/ecr init
terraform -chdir=$HOME/ecs-terraform/ecs init
```

Install dependencies from container-docker directory:

```sh
cd container-docker
npm i
```

If you want to run `terraform apply` locally, make sure that you have setted up aws credentials in ~/.aws/credentials.

Otherwise, if you prefer to run apply remotely, follow these steps:

1. Sign in your HCP Terraform account;
2. Run `terraform login`;
3. Authenticate with token generated by your account.

Look for ecs/variables.tf and ecr/variables.tf to set up terraform variables.

## ECR

To apply Terraform ECR, run:

```sh
cd ecr
terraform apply
```

It will create a repository in ECR with name defined in variable `container_image`, this repository will have a policy that exlude images version when it exceeds 10 versions.

## ECS Fargate

To apply Terraform ECS, run:

```sh
sh ./scripts/deploy-terraform.sh
```

It will execute follows steps:

1. make login on ecr using aws cli;
2. build the docker image from container-docker directory;
3. apply tag to docker image;
4. push docker image to ecr repository;
5. run terraform apply to deploy infra;
